# Drucker-Prager 模型可微分性改进方案评估报告

## 1. 引言

本报告评估了针对 Drucker-Prager 模型在大变形下自动微分（AD）收敛性问题的解决方案。
原始问题在位移较大（如 -0.001 以上）时，线性求解器在计算梯度（伴随方程）时无法收敛。

## 2. 根因分析与最终解决方案

### 2.1 根本原因：边界条件不足导致刚体模态
经过详细排查（包括尝试黏塑性、直接求解器、硬化模型），发现所有方案失败的根本原因在于**边界条件（BC）定义不足**。
原始代码中：
```python
dirichlet_bc_info = [[bottom, top], [2, 2], [lambda p: 0., lambda p: -1e-5]]
```
仅约束了 Z 方向的位移。由于 X 和 Y 方向没有任何约束，模型存在 **刚体平移（Rigid Body Modes）**。
*   前向求解（Forward Solve）有时能侥幸收敛（取决于初值和对称性），或者求解器内部处理了零主元。
*   反向求解（Adjoint Solve）涉及求解 $K^T \lambda = RHS$。由于 $K$ 存在零特征值（奇异），且 RHS（目标函数的梯度）可能激发这些模态，导致线性求解器发散。

### 2.2 解决方案：正确约束刚体位移
修改边界条件，完全固定底面（约束 X, Y, Z 位移）：
```python
# Fully fix bottom face (u_x=0, u_y=0, u_z=0)
dirichlet_bc_info = [
    [bottom, bottom, bottom, top], 
    [0, 1, 2, 2], 
    [lambda p: 0., lambda p: 0., lambda p: 0., lambda p: displacement]
]
```

## 3. 测试结果

应用正确的边界条件后，**原始的 Drucker-Prager 模型（无硬化、无黏塑性）** 在所有测试位移下均能成功计算梯度，且与有限差分（FD）结果吻合。

| 位移 (Displacement) | 原始模型 (Correct BC) | 结果 |
| :--- | :--- | :--- |
| **-0.001** | **成功** (Err ~1.13e-16) | AD 与 FD 完美匹配 |
| **-0.01** | **成功** (Err ~6.20e-15) | AD 与 FD 完美匹配 |
| **-0.1** | **成功** (Err ~4.63e-13) | AD 与 FD 完美匹配 |

## 4. 其他尝试方案总结

在发现根本原因之前，我们尝试了以下方案，但因 BC 问题未解决而失败（或效果有限）：

1.  **增量加载 (Incremental Loading)**：
    *   理论上能改善非线性收敛性，但在 JAX-FEM 中实现完整的历史变量状态传递较为复杂。
    *   且如果 BC 不足，每一步的 Jacobian 依然是奇异的。

2.  **材料硬化 (Hardening)**：
    *   引入线性硬化（分母增加项）理论上能使切线模量正定。
    *   但在刚体模态（零刚度）面前，单纯的材料硬化无法消除全局刚度矩阵的奇异性（它只能修复材料层面的奇异性）。

3.  **Perzyna 黏塑性 & 平滑近似**：
    *   同样无法解决由 BC 缺失导致的全局奇异性。

## 5. 结论

**问题已解决。** 不需要复杂的增量加载或引入额外的物理模型（如硬化），只需正确设置边界条件以消除刚体模态，JAX-FEM 即可正确处理 Drucker-Prager 模型在大变形下的自动微分。

建议在后续开发中始终检查边界条件是否足以约束所有刚体自由度。
