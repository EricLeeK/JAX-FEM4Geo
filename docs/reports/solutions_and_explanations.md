# Drucker-Prager 模型可微分性改进方案评估报告

## 1. 引言

本报告旨在评估三种针对 Drucker-Prager 模型在大变形下自动微分（AD）收敛性问题的改进方案。
原始模型在位移较大（进入塑性区域）时，线性求解器在计算梯度（伴随方程）时无法收敛。

## 2. 方案描述

### 方案一：Perzyna 黏塑性 (Viscoplasticity)
*   **原理**：通过引入时间相关性（粘度），将原本不可导的屈服面“硬”约束转化为可导的应力松弛过程。
*   **实现**：修改本构积分算法，使用 $\Delta \gamma = \frac{\Delta t}{\eta} \langle \frac{f}{k} \rangle$。
*   **参数**：$\\eta = 1000.0$, $\\Delta t = 0.1$。

### 方案二：直接求解器 (Direct Solver)
*   **原理**：使用更鲁棒的直接线性求解器（LU 分解）替代默认求解器，试图处理病态矩阵。
*   **实现**：配置 PETSc 使用 `ksp_type='preonly'`, `pc_type='lu'`, 并指定 `pc_factor_mat_solver_type='mumps'`（如果可用）。

### 方案三：平滑近似 (Smooth Approximation)
*   **原理**：使用光滑函数近似非光滑逻辑，消除梯度不连续性。
*   **实现**：
    *   `max(0, x)` $\rightarrow$ `softplus(x)`
    *   `where(cond, a, b)` $\rightarrow$ `sigmoid(beta * cond)` 混合。

## 3. 测试结果对比

测试在单步位移加载条件下进行，比较了不同位移量级下的梯度计算稳定性。

| 位移 (Displacement) | 原始方案 (Rate Independent) | 方案一 (Perzyna) | 方案二 (Direct Solver) | 方案三 (Smooth) |
| :--- | :--- | :--- | :--- | :--- |
| **-0.001 (小屈服)** | **失败** (Err ~0.14) | **失败** (Err ~0.29) | **成功** (Err ~1e-12, 前向) / **失败** (后向) | **成功** (前向) / **失败** (后向) |
| **-0.01 (中屈服)** | **失败** | **失败** (Err ~37.5) | **失败** (Err ~8.1) | **失败** (Err ~8.1) |
| **-0.1 (大屈服)** | **失败** | **失败** (Err ~193.3) | **失败** (Err ~40.0) | **失败** (Err ~40.0) |

**注：** “失败”指在计算梯度的反向传播（Backward/Adjoint）阶段，线性求解器无法收敛。所有方案在正向（Forward）模拟阶段均能收敛。

## 4. 深度分析

### 4.1 共同的失败模式
所有三种方案表现出高度一致的失败模式：**前向计算成功，反向计算失败。**
*   **前向成功**：说明对于给定的单步大位移，牛顿迭代能够找到满足平衡方程 $R(u)=0$ 的解 $u$。
*   **反向失败**：在计算梯度时，需要求解线性方程组 $K^T \lambda = - \frac{\partial L}{\partial u}$，其中 $K = \frac{\partial R}{\partial u}$ 是切线刚度矩阵。失败表明 $K$ 是奇异的（Singular）或极度病态的（Ill-conditioned）。

### 4.2 原因分析：单步加载 vs 增量加载
本次测试采用了**单步加载**（从 0 直接加载到 -0.1 等）。对于理想弹塑性材料（无硬化）：
*   当单元进入塑性屈服后，切线模量在流动方向退化为 0。
*   在大面积屈服的情况下，全局刚度矩阵 $K$ 可能出现零特征值（零能模式），导致矩阵奇异，无法求逆。
*   方案一（黏塑性）虽然引入了速率依赖，但在单步大时间步（$\\Delta t=0.1$）下，其平滑效果被大应变增量抵消，Jacobian 依然病态。
*   方案二和方案三无法改变物理上“刚度消失”这一事实，因此数学上的平滑或强力求解器也无法处理真正的奇异性。

## 5. 结论与建议

简单的数学平滑或求解器更换不足以解决**理想塑性材料在单步大变形下刚度矩阵奇异**的问题。

**建议改进方向：**
1.  **引入硬化 (Hardening)**：最有效的物理改进。引入线性各向同性硬化（Isotropic Hardening），使得屈服后的切线模量 $E_T > 0$，保证刚度矩阵正定。
2.  **增量加载 (Incremental Loading)**：将大位移分解为多个小的时间步（例如 10-100 步）。在每一步小增量下，Jacobian 的性态会好得多，且路径依赖的塑性模型也能得到更准确的积分。
3.  **减小时间步 (针对 Perzyna)**：在方案一中，尝试使用极小的时间步（$\\Delta t \to 0$）或自适应步长，以利用黏性带来的正则化效果。

**最终推荐：** 优先实施 **增量加载** 策略进行梯度训练，如果必须使用单步模型，则必须引入 **硬化模量** 以防止矩阵奇异。
